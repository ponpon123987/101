<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Device Connectivity</title>
    <script>
	</script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <!--<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>-->          
    
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <!--<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">-->
</head>
<body>
        <nav id="navbar">	
            <div class="container">
                <div class="logo">
                    <a href="/"><img src="images/wise-paas-logo.png" alt="Wise-PaaS Logo"></a>
                </div>
                <!---->
                <div>
					<ul>
						<li id="logoutNav"><a href="https://portal-sso.wise-paas.io/web/signOut.html">Logout</a></li>
						<li class="dropdown"><a href="#">Services</a>
							<ul class="dropdown-content">
								<li class="dropdown-elements"><a href="/device.html"><img src="images/dev.png" alt="device_s">Create Connection</a></li>
								<li class="dropdown-elements"><a href="/check.html"><img src="images/cld.png" alt="cloud_s">App Deployment</a></li>
								<li class="dropdown-elements"><a href="#"><img src="images/db.png" alt="db_s">Database Services</a></li>
								<li class="dropdown-elements"><a href="#"><img src="images/app.png" alt="app_s">Data Application</a></li>
							</ul>
						</li>
						<li><a href="/">Home</a></li>
					</ul>
				</div>
                
            </div>
        </nav>
        <section id="microService">
            <br>
            <div  class="container">
                <!--Service Input Form-->

                <div id='inputservice'>
                        
                            <img src="images/rabbitmq-logo.png" alt="rabbitmq-logo">
                            <h2>Generate RabbitMQ Source Code</h2>
                        
                            <div class="from-group">
                                <label>Application Name*: </label>
                                <input class="form-control  " type="text" id="appName" placeholder=" myApp">
                                
                            </div>
                     
                             <div class="form-group">
                                <label>Service Instance Name*: </label>
                                <input class="form-control" type="text" id="serviceInstanceName" placeholder=" rabbitmq-demo">
                                
                            </div>
                            <div class="form-group">
                                <label>Service Name*:</label>
                                <select class="custom-select" id="serviceName" >
                                    <option value="p-rabbitmq">p-rabbitmq</option>
                                    <option value="p-rabbitmq-innoworks">p-rabbitmq-innoworks</option>
                                </select>
                                
                            </div>
                            <div class="form-group">
                                <label>Application Memory(MB)*:</label>
                                <input class="form-control" type="number" id='applicationmemory' placeholder=" 128">
                                
                            </div>
                            <div class="form-group">
                                <label>Application Disk Quota(MB)*:</label>
                                <input  class="form-control" type="number" id='applicationdiskquota' placeholder=" 128">
                                
                            </div>
                            <div class="form-group">
                                <label>Topic*:</label>
                                <input class="form-control" type="text" id="topic" placeholder=" topicName">
                                
                            </div>
                            <div id='warnings' style='color: red; padding-top: 10px'>* values are required</div>
                            <button id='getservice' class='normalButton'>Generate</button> 
                            <a href="device.html" id='reGetService'>Generate a new source?</a>
                        </div>
                    

                <!--Code Block-->
                <div class='code-panel'>
                        <div class='README'>
                            <h2 class="stepTitle"><img src="images/md.png" alt="markdown"> README</h2>
                            <div class="descriptionPanel">
                            <pre>                      
    Welcome to WISE-PaaS Quick Start Site
    We provide: 
        - JavaScript / Python source codes
        - Step-by-Step deployment tutorial
                                        
    The source codes are provided by Advantech,
    Please do not copy or share without citation.
                            </pre>
                            </div>

                        </div>
                        
                        <div class="sampleSource">
                            <h2 class="stepTitle">Step 1. Login to your domain</h2>
                            <hr>
                            <div class="descriptionPanel">
                                <p><img src="images/md.png" alt="markdown"> The WISE-PaaS cloud engine is 
                                    powered by Cloud Foundry, so we use cf commands to login to our domain:
                                    <div class='codeInText'><code>cf login -a api.{domainName} -u {userName} -p {password}</code></div></p>
                            </div>
                            
                            <pre><code id="cmdLogin">  
    I'm Login Command</code>
                            </pre>
                            <br>
                            <!-- This is a comment -->
                            <h2 class="stepTitle">Step 2. Create a new service instance</h2>
                            <hr>
                            <div class="descriptionPanel">
                                <p><img src="images/md.png" alt="markdown"> Here, we create a new service 
                                    instance, the cf command we use here is:<div class='codeInText'><code>
                                    cf create-service {serviceName} {servicePlan} {serviceInstanceName}</code></div></p>
                            </div>
                            <pre>
                                <code id="cmdCS">
    I'm Create Service</code>
                            </pre>
                            <br>
                            <!-- This is a comment -->
                            <h2 class="stepTitle">Step 3. Source code</h2>
                            <hr>
                            <div class="descriptionPanel">
                                <p><img src="images/md.png" alt="markdown"> The source code below is an app 
                                    that subscribes to the topic we've set and listens to data via the MQTT 
                                    protocal. To use this app correctly, remember to save it as: 'app.js'. 
                                    To test this code locally, remember to run 
                                    <strong class='codeInText'><code>npm init</code></strong> to initialize a 
                                    package.json file. After initializing the project, we would need to install 
                                    the node packages: <strong class='codeInText'><code>npm install {nodePackage} 
                                    --save</code></strong> . Then, to start the NodeJS server, run 
                                    <strong class='codeInText'><code>node app.js</code></strong> .</p>
                            </div>
                            <pre>
                                <code id="printSrcCode">
    I'm Source Code</code>
                            </pre>
                            <br>
                            <!-- This is a comment -->
                            <h2 class="stepTitle">Step 4. Manifest File (Save as 'manifest.yml')</h2>
                            <hr>
                            <div class="descriptionPanel">
                                <p><img src="images/md.png" alt="markdown"> The text below is the 'manifest file'.
                                Remember to save it as 'manifest.yml'. If you are going to write your own manifest,
                                we provide a web-tool to help you check for basic syntax errors --> 
                                <a href="/check.html"> Check Manifest</a></p>
                            </div>
                            <pre>
                                <code id="printManifest">
    I'm Manifest</code>
                            </pre>
                            <br>
                            <!-- This is a comment -->
                            <h2 class="stepTitle">Step 5. App Deployment</h2>
                            <hr>
                            <div class="descriptionPanel">
                                <p><img src="images/md.png" alt="markdown"> Now, we have saved our NodeJS source and 
                                our manifest, we may deploy our App. Now, in the folder where we saved our 'app.js' 
                                and 'manifest.yml', we use the command: 
                                <strong class='codeInText'><code>cf push {appName}</code></strong> to deploy our App 
                                onto WISE-PaaS</p>
                            </div>
                            <pre>
                                <code id="printGuide">
    I'm Deployment Guide</code>
                            </pre>
                            <br>
                            <!-- This is a comment -->
                            <h2 id="experimentGuide">Step 6. Experiment</h2>
                            <hr>
                            <div class="descriptionPanel">
                                <p><img src="images/md.png" alt="markdown"> If there are any errors, use the command: 
                                <strong class='codeInText'><code>cf logs {appName} --recent</code></strong> to check the logs. 
                                Now, our app has been successfully started, we may do some tests, either by 
                                <a href="http://workswithweb.com/html/mqttbox/downloads.html">MQTTBox</a> or 
                                write your own <a href="https://github.com/WISE-PaaS/edge-mock-temperature">mock device</a> to send data. 
                                Remember that either ways, you would need to get the service credentials, you can get credentials by 
                                logging in to the <a href="https://portal-management.wise-paas.io/organizations">management portal</a> 
                                or via command: <strong class='codeInText'><code>cf env {appName} >> env.json</code></strong> to save
                                environment variables as a JSON file then use them in your code or in MQTTBox. After you start sending data
                                (don't forget to use the topic you have set), you may use the command: 
                                <strong class='codeInText'><code>cf logs {appName} --recent</code></strong> or via management portal's
                                app log to check if you have received data.</p>
                            </div>
                            <pre>
                                <code id="printExample">
    I'm Experiment Guide</code>
                            </pre>
                            <br>
                            <!-- This is a comment -->
                            <h4>Want to check out other examples?  <a class="learnMore" href="https://github.com/wise-paas">Learn More</a></h4>
                        </div>
                </div>
                
            </div>
            <br>
            
        </section>
        <footer id="main-footer">
            <p>Copyright &copy; 2019 Advantech</p>
        </footer>
    </body>

<script>
    $(document).ready(()=>{

        /*SSO Check*/
		$.ajax({
		    url: 'https://portal-sso.wise-paas.io/v2.0/users/me',
				method: 'GET',
				xhrFields: {
					withCredentials: true
				}
			}).done(function(){
				device_link = document.location.href;
				if(device_link.includes('http://')){
					alert('Remember to use https:// next time');
					let safeLink = device_link.replace('http://','https://');
					window.location.href = safeLink;
				}
			}).fail(function(){
				alert('Please login');
				device_link = document.location.href;
				let correctLink = device_link.replace('http://','https://');
				window.location.href = `https://portal-sso.wise-paas.io/web/signIn.html?redirectUri=${correctLink}`;
			})
        //////////////////////////////////////////
        
        $(".sampleSource").hide();
        $("#reGetService").hide();
        $("#warnings").hide();
        
        $("#getservice").click(()=>{
            //get input value 
            var serviceName = $("#serviceName").val();
            var topic = $("#topic").val()
            var appName = $("#appName").val()
            var serviceInstance = $("#serviceInstanceName").val()
            var applicationmemory = $("#applicationmemory").val()
            var applicationdiskquota = $("#applicationdiskquota").val()
           
            if(serviceName === '' || topic === '' || appName === '' || applicationmemory === '' || applicationdiskquota === '')
            {
                $("#warnings").show()
            }
            else
            {
                $("#reGetService").show();
                $(".README").hide();
                $("#getservice").hide();
                $("#microService").height("max-content");
                $(".sampleSource").show();
                $("#warnings").hide()
                let cookie = {};
                document.cookie.split(';').forEach(function(el) {
                    let [k,v] = el.split('=');
                    cookie[k.trim()] = v;
                })
                var account = cookie.WISEUser;
                var hostname = window.location.hostname;
                const loginCmd =`    
    cf login -a api.`+hostname.split('.',3)[1]+`.`+hostname.split('.',3)[2]+` -u `+account + ` -p WISE-PaaS/EnSaaS-password`;
            $("#cmdLogin").text(loginCmd);
            

            const csCmd = `    
    cf create-service ${serviceName} standard ${serviceInstance}`;
            $("#cmdCS").text(csCmd);
        
                //get api
                fetch('/indexFile',{method:'POST',headers: {'Content-Type': 'application/json'},body:JSON.stringify({type:'rabbitmq',topic:topic,serviceName:serviceName})})
                .then((res)=>{
                    res.text()
                .then((body)=>{
                    $("#printSrcCode").text(body)
                    })
                })
                
                fetch('/manifest',{method:'POST',headers: {'Content-Type': 'application/json'},body:JSON.stringify({app_Name:appName,service_instance:serviceInstance,application_memory:applicationmemory,application_diskqouta:applicationdiskquota})})
                .then((res)=>{
                    res.text()
                .then((body)=>{
                    $("#printManifest").text(body)
                    })
                })

                fetch('/deploy',{method:'POST',headers: {'Content-Type': 'application/json'},body:JSON.stringify({appName:appName})})
                .then((res)=>{
                    res.text()
                .then((body)=>{
                    $("#printGuide").text(body)
                    })
                })

                // fetch('/experiment',{method:'POST',headers: {'Content-Type': 'application/json'},body:JSON.stringify({appName:appName})})
                // .then((res)=>{
                //     res.text()
                // .then((body)=>{
                //     $("#printExample").text(body)
                //     })
                // })

            }
            
        })
    })
</script>

</html>





